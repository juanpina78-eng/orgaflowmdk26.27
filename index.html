<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mondraker Organizational Chart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
      
      body { 
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background: #ffffff;
        overflow: hidden; 
        margin: 0;
        padding: 0;
      }
      
      .node-card { 
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
      }
      
      .node-card:hover { 
        transform: translateY(-4px) scale(1.02);
        filter: drop-shadow(0 8px 16px rgba(0, 113, 185, 0.3));
      }
      
      .node-card.highlighted { 
        stroke: #0071B9;
        stroke-width: 3;
        filter: drop-shadow(0 0 20px rgba(0, 113, 185, 0.8));
        animation: pulse 2s infinite;
      }
      
      @keyframes pulse {
        0%, 100% { filter: drop-shadow(0 0 20px rgba(0, 113, 185, 0.8)); }
        50% { filter: drop-shadow(0 0 30px rgba(0, 113, 185, 1)); }
      }
      
      .search-input {
        transition: all 0.3s;
        border: 2px solid #e2e3e4;
        background: #ffffff;
        color: #000000;
      }
      
      .search-input:focus {
        border-color: #0071B9;
        box-shadow: 0 0 0 3px rgba(0, 113, 185, 0.1);
        outline: none;
      }
      
      .search-input::placeholder {
        color: #999;
      }
      
      #modal { 
        backdrop-filter: blur(10px);
        background: rgba(255, 255, 255, 0.95);
      }
      
      .fade-in { 
        animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      @keyframes fadeIn { 
        from { opacity: 0; transform: translateY(-20px) scale(0.95); } 
        to { opacity: 1; transform: translateY(0) scale(1); } 
      }
      
      .btn-mondraker {
        background: #0071B9;
        transition: all 0.3s;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .btn-mondraker:hover {
        background: #005a94;
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 113, 185, 0.4);
      }
      
      .btn-secondary {
        background: #e2e3e4;
        color: #000000;
        transition: all 0.3s;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .btn-secondary:hover {
        background: #d0d1d2;
        transform: translateY(-1px);
      }
      
      .btn-export {
        background: #ffffff;
        border: 2px solid #0071B9;
        color: #0071B9;
        transition: all 0.3s;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .btn-export:hover {
        background: #0071B9;
        color: #ffffff;
        transform: translateY(-2px);
      }
      
      .logo-mondraker {
        font-weight: 800;
        letter-spacing: -0.5px;
        color: #000000;
      }
      
      .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(0, 113, 185, 0.3);
        border-radius: 50%;
        border-top-color: #0071B9;
        animation: spin 1s ease-in-out infinite;
      }
      
      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      .dropdown {
        position: relative;
        display: inline-block;
      }

      .dropdown-content {
        display: none;
        position: absolute;
        background-color: #ffffff;
        min-width: 200px;
        box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.15);
        z-index: 1;
        border: 2px solid #e2e3e4;
        border-radius: 8px;
        margin-top: 8px;
      }

      .dropdown-content button {
        color: #000000;
        padding: 12px 16px;
        text-decoration: none;
        display: block;
        width: 100%;
        text-align: left;
        border: none;
        background: none;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        transition: all 0.2s;
      }

      .dropdown-content button:hover {
        background-color: #0071B9;
        color: #ffffff;
      }

      .dropdown-content.show {
        display: block;
      }

      #exportingOverlay {
        backdrop-filter: blur(5px);
        background: rgba(255, 255, 255, 0.9);
      }
    </style>
</head>
<body class="w-screen h-screen">
    <!-- Overlay de exportaci√≥n -->
    <div id="exportingOverlay" class="hidden fixed inset-0 z-[100] flex items-center justify-center">
      <div class="bg-white border-2 border-blue-500 rounded-2xl p-8 text-center shadow-2xl">
        <div class="loading mx-auto mb-4" style="width: 40px; height: 40px; border-width: 4px;"></div>
        <p class="text-black text-lg font-bold">Exporting chart...</p>
        <p class="text-gray-600 text-sm mt-2">Please wait a moment</p>
      </div>
    </div>

    <!-- Panel de Control Superior -->
    <div class="absolute top-0 left-0 right-0 z-50 bg-white border-b-2 border-gray-200 fade-in shadow-sm">
      <div class="max-w-7xl mx-auto px-6 py-4">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-4">
            <h1 class="logo-mondraker text-2xl">MONDRAKER</h1>
            <span class="text-gray-500 text-sm font-light">Organizational Chart</span>
          </div>
          <div class="flex items-center gap-4">
            <div class="text-gray-600 text-sm">
              <span id="employeeCount"><span class="loading"></span> Loading data...</span>
            </div>
            
            <!-- Bot√≥n de Exportar -->
            <div class="dropdown">
              <button onclick="toggleDropdown(event)" class="btn-export px-5 py-3 rounded-lg text-xs flex items-center gap-2">
                üì• EXPORT
                <span class="text-xs">‚ñº</span>
              </button>
              <div id="exportDropdown" class="dropdown-content">
                <button onclick="exportToPNG()">üì∑ Export as PNG</button>
                <button onclick="exportToPDF()">üìÑ Export as PDF</button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="flex flex-wrap gap-3 items-center">
          <!-- B√∫squeda -->
          <div class="flex-1 min-w-72">
            <input 
              type="text" 
              id="searchInput" 
              placeholder="üîç Search employee by name, role or department..." 
              class="search-input w-full px-4 py-3 rounded-lg text-sm font-medium"
            />
          </div>
          
          <!-- Filtros por Departamento -->
          <div class="flex gap-2 flex-wrap">
            <button onclick="filterDept('all')" class="dept-btn btn-mondraker px-4 py-2.5 text-white rounded-lg text-[10px]">
              ALL
            </button>
            <button onclick="filterDept('Producto')" class="dept-btn btn-secondary px-4 py-2.5 text-white rounded-lg text-[10px]">
              PRODUCT
            </button>
            <button onclick="filterDept('RRHH')" class="dept-btn btn-secondary px-4 py-2.5 text-white rounded-lg text-[10px]">
              HR
            </button>
            <button onclick="filterDept('FINANCE')" class="dept-btn btn-secondary px-4 py-2.5 text-white rounded-lg text-[10px]">
              FINANCE
            </button>
            <button onclick="filterDept('MARKETING')" class="dept-btn btn-secondary px-4 py-2.5 text-white rounded-lg text-[10px]">
              MARKETING
            </button>
            <button onclick="filterDept('OPERATIONS')" class="dept-btn btn-secondary px-4 py-2.5 text-white rounded-lg text-[10px]">
              OPERATIONS
            </button>
            <button onclick="filterDept('WAREHOUSE')" class="dept-btn btn-secondary px-4 py-2.5 text-white rounded-lg text-[10px]">
              WAREHOUSE
            </button>
            <button onclick="filterDept('PRODUCTION')" class="dept-btn btn-secondary px-4 py-2.5 text-white rounded-lg text-[10px]">
              PRODUCTION
            </button>
            <button onclick="filterDept('IT')" class="dept-btn btn-secondary px-4 py-2.5 text-white rounded-lg text-[10px]">
              IT
            </button>
            <button onclick="filterDept('SALES')" class="dept-btn btn-secondary px-4 py-2.5 text-white rounded-lg text-[10px]">
              SALES
            </button>
            <button onclick="filterDept('CUSTOMER SERVICE')" class="dept-btn btn-secondary px-4 py-2.5 text-white rounded-lg text-[10px]">
              CUSTOMER SERVICE
            </button>
          </div>
          
          <!-- Controles de Navegaci√≥n -->
          <div class="flex gap-2">
            <button onclick="resetZoom()" class="btn-secondary px-4 py-2.5 text-white rounded-lg text-[10px]">
              üè† START
            </button>
            <button onclick="zoomIn()" class="btn-secondary px-4 py-2.5 text-white rounded-lg text-[10px]">
              ‚ûï
            </button>
            <button onclick="zoomOut()" class="btn-secondary px-4 py-2.5 text-white rounded-lg text-[10px]">
              ‚ûñ
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Contenedor del Organigrama -->
    <div id="chart-container" class="w-full h-full pt-36"></div>

    <!-- Modal de Detalles -->
    <div id="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4" onclick="closeModal(event)">
      <div class="bg-white border-2 border-gray-200 rounded-2xl shadow-2xl max-w-lg w-full p-8 fade-in" onclick="event.stopPropagation()">
        <div class="flex justify-between items-start mb-6">
          <div>
            <h2 id="modalName" class="text-3xl font-bold text-black mb-1"></h2>
            <div class="h-1 w-16 bg-gradient-to-r from-blue-500 to-transparent"></div>
          </div>
          <button onclick="closeModal()" class="text-gray-400 hover:text-black text-3xl transition">&times;</button>
        </div>
        
        <div class="space-y-4">
          <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
            <p class="text-xs text-gray-500 uppercase tracking-wider mb-1 font-semibold">Role</p>
            <p id="modalRole" class="text-lg font-bold text-black"></p>
          </div>
          
          <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
            <p class="text-xs text-gray-500 uppercase tracking-wider mb-1 font-semibold">Department</p>
            <p id="modalDept" class="text-lg font-bold text-blue-600"></p>
          </div>
          
          <div id="modalEmailSection" class="bg-gray-50 rounded-lg p-4 border border-gray-200 hidden">
            <p class="text-xs text-gray-500 uppercase tracking-wider mb-1 font-semibold">Email</p>
            <a id="modalEmail" href="#" class="text-base font-semibold text-blue-600 hover:text-blue-700 transition"></a>
          </div>
          
          <div id="modalPhoneSection" class="bg-gray-50 rounded-lg p-4 border border-gray-200 hidden">
            <p class="text-xs text-gray-500 uppercase tracking-wider mb-1 font-semibold">Phone</p>
            <p id="modalPhone" class="text-base font-semibold text-black"></p>
          </div>
          
          <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
            <p class="text-xs text-gray-500 uppercase tracking-wider mb-1 font-semibold">Direct Reports</p>
            <p id="modalReports" class="text-lg font-bold text-black"></p>
          </div>
        </div>
      </div>
    </div>

    <!-- Sistema de carga con m√∫ltiples CDNs de respaldo -->
    <script>
      (function() {
        let scriptsLoaded = {
          d3: false,
          html2canvas: false,
          jspdf: false
        };
        
        let loadAttempts = {
          d3: 0,
          html2canvas: 0,
          jspdf: 0
        };
        
        // CDNs alternativos para cada librer√≠a
        const cdnOptions = {
          d3: [
            'https://d3js.org/d3.v7.min.js',
            'https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js',
            'https://unpkg.com/d3@7/dist/d3.min.js'
          ],
          html2canvas: [
            'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js',
            'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js',
            'https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js'
          ],
          jspdf: [
            'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
            'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js',
            'https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js'
          ]
        };
        
        function checkAllLoaded() {
          return scriptsLoaded.d3 && scriptsLoaded.html2canvas && scriptsLoaded.jspdf;
        }
        
        function tryInitialize() {
          if (checkAllLoaded() && typeof initializeApp === 'function') {
            console.log('‚úÖ All libraries loaded successfully!');
            initializeApp();
          }
        }
        
        function loadScriptWithFallback(name, urls, index = 0) {
          if (index >= urls.length) {
            console.error(`‚ùå Failed to load ${name} from all CDNs`);
            if (name === 'd3') {
              document.getElementById('employeeCount').innerHTML = 
                '<span class="text-red-500">‚ö†Ô∏è Error: Cannot load D3 library. Check your internet connection or firewall settings.</span>';
            }
            return;
          }
          
          const url = urls[index];
          console.log(`‚è≥ Loading ${name} from CDN ${index + 1}/${urls.length}: ${url.split('/')[2]}`);
          
          const script = document.createElement('script');
          script.src = url;
          
          script.onload = function() {
            console.log(`‚úÖ ${name} loaded from ${url.split('/')[2]}`);
            scriptsLoaded[name] = true;
            loadAttempts[name] = index + 1;
            tryInitialize();
          };
          
          script.onerror = function() {
            console.warn(`‚ö†Ô∏è Failed to load ${name} from ${url.split('/')[2]}, trying next CDN...`);
            loadAttempts[name]++;
            // Intentar con el siguiente CDN
            setTimeout(() => loadScriptWithFallback(name, urls, index + 1), 500);
          };
          
          document.body.appendChild(script);
        }
        
        // Iniciar carga de todas las librer√≠as
        loadScriptWithFallback('d3', cdnOptions.d3);
        loadScriptWithFallback('html2canvas', cdnOptions.html2canvas);
        loadScriptWithFallback('jspdf', cdnOptions.jspdf);
        
        // Timeout de seguridad (30 segundos)
        setTimeout(function() {
          if (!checkAllLoaded()) {
            console.error('‚ùå Timeout: Not all libraries loaded after 30 seconds');
            console.log('Status:', scriptsLoaded);
            if (!scriptsLoaded.d3) {
              document.getElementById('employeeCount').innerHTML = 
                '<span class="text-red-500">‚ö†Ô∏è Error: Network timeout. Please check your connection and reload the page.</span>';
            }
          }
        }, 30000);
      })();
    </script>

    <script>
      // ============================================
      // CONFIGURACI√ìN
      // ============================================
      const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbywyIp6chrjmy30T7Dj8wTp9biDw_W1c3NXuRUeRo18rluWWRyH2asrIktjGBr7NISs/exec';

      // Variables globales
      let allData = [];
      let currentFilter = 'all';
      let svg, g, zoom, root, tree;
      
      const CARD_WIDTH = 275;
      const CARD_HEIGHT = 90;
      const SPACING_V = 120;
      const SPACING_H = 340;
      const width = window.innerWidth;
      const height = window.innerHeight;

      // Funci√≥n para convertir datos planos a jerarqu√≠a usando IDs
      function buildHierarchy(flatData) {
        const map = {};
        const roots = [];
        
        // Crear mapa con IDs como clave
        flatData.forEach(person => {
          map[person.id] = {
            id: person.id,
            name: person.name,
            role: person.role,
            department: person.department,
            email: person.email || '',
            phone: person.phone || '',
            children: []
          };
        });
        
        // Construir jerarqu√≠a usando manager_id
        flatData.forEach(person => {
          if (person.manager_id && map[person.manager_id]) {
            map[person.manager_id].children.push(map[person.id]);
          } else {
            roots.push(map[person.id]);
          }
        });
        
        return roots.length === 1 ? roots[0] : { 
          id: "root", 
          name: "Organization", 
          role: "", 
          department: "", 
          children: roots 
        };
      }

      // Cargar datos desde Apps Script
      async function loadData() {
        try {
          console.log('üîÑ Loading data from Google Sheets...');
          const response = await fetch(APPS_SCRIPT_URL);
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          
          const data = await response.json();
          console.log('‚úÖ Data received:', data);
          
          if (data.error) {
            throw new Error(data.error);
          }
          
          // Validar que los datos tienen IDs
          const missingIds = data.filter(person => !person.id);
          if (missingIds.length > 0) {
            console.warn('‚ö†Ô∏è Warning: Some employees are missing IDs:', missingIds);
          }
          
          allData = data;
          initializeChart();
        } catch (error) {
          console.error('‚ùå Error loading data:', error);
          document.getElementById('employeeCount').innerHTML = 
            '<span class="text-red-500">‚ö†Ô∏è Error: ' + error.message + '</span>';
        }
      }

      // Inicializar el organigrama
      function initializeChart() {
        console.log('üìä Initializing chart with', allData.length, 'employees');
        
        document.getElementById('employeeCount').innerHTML = 
          `<span class="text-black font-bold">${allData.length}</span> <span class="text-gray-500">employees</span>`;
        
        svg = d3.select("#chart-container").append("svg")
          .attr("viewBox", [-width / 2, -height / 2, width, height])
          .style("width", "100%")
          .style("height", "100%");

        g = svg.append("g");
        
        zoom = d3.zoom()
          .scaleExtent([0.1, 4])
          .on("zoom", (e) => g.attr("transform", e.transform));
        
        svg.call(zoom);
        
        renderChart(allData);
        resetZoom();
      }

      // Renderizar organigrama
      function renderChart(data) {
        g.selectAll("*").remove();
        
        const hierarchyData = buildHierarchy(data);
        root = d3.hierarchy(hierarchyData);
        tree = d3.tree().nodeSize([SPACING_V, SPACING_H]);
        tree(root);

        // Links (conexiones)
        g.append("g")
          .attr("fill", "none")
          .attr("stroke", "#0071B9")
          .attr("stroke-opacity", 0.4)
          .attr("stroke-width", 2)
          .selectAll("path")
          .data(root.links())
          .join("path")
          .attr("d", d3.linkHorizontal().x(d => d.y).y(d => d.x));

        // Nodos
        const node = g.append("g")
          .selectAll("g")
          .data(root.descendants())
          .join("g")
          .attr("transform", d => `translate(${d.y},${d.x})`)
          .attr("class", "node-group");

        // Tarjeta principal
        node.append("rect")
          .attr("width", CARD_WIDTH)
          .attr("height", CARD_HEIGHT)
          .attr("x", 0)
          .attr("y", -CARD_HEIGHT / 2)
          .attr("rx", 8)
          .attr("fill", "#ffffff")
          .attr("stroke", "#e2e3e4")
          .attr("stroke-width", 2)
          .attr("class", "node-card")
          .on("click", (event, d) => showModal(d.data));

        // Barra superior con color por departamento
        const departmentColors = {
          'Producto': '#0071B9',      // Azul Mondraker (Product)
          'RRHH': '#10b981',          // Verde esmeralda (HR)
          'FINANCE': '#f59e0b',       // √Åmbar/Naranja (Finance)
          'MARKETING': '#ec4899',     // Rosa/Magenta (Marketing)
          'OPERATIONS': '#8b5cf6',    // P√∫rpura (Operations)
          'WAREHOUSE': '#06b6d4',     // Cyan (Warehouse)
          'PRODUCTION': '#ef4444',    // Rojo (Production)
          'IT': '#6366f1',            // √çndigo (IT)
          'SALES': '#14b8a6',         // Teal (Sales)
          'CUSTOMER SERVICE': '#f97316' // Naranja brillante (Customer Service)
        };
        
        node.append("rect")
          .attr("width", CARD_WIDTH)
          .attr("height", 6)
          .attr("x", 0)
          .attr("y", -CARD_HEIGHT / 2)
          .attr("rx", 8)
          .attr("fill", d => departmentColors[d.data.department] || '#0071B9');

        // Nombre
        node.append("text")
          .attr("dy", -12)
          .attr("x", 16)
          .text(d => d.data.name)
          .attr("class", "font-bold text-sm")
          .attr("fill", "#000000");

        // Puesto (con wrap)
        node.each(function(d) {
          const el = d3.select(this);
          const roleText = el.append("text")
            .attr("x", 16)
            .attr("y", 8)
            .attr("class", "text-[11px] font-medium uppercase tracking-wide")
            .attr("fill", "#666");

          const words = d.data.role.split(/\s+/).reverse();
          let line = [];
          const lineHeight = 1.3;
          const maxWidth = CARD_WIDTH - 32;
          let tspan = roleText.append("tspan").attr("x", 16).attr("dy", "0em");
          
          let word;
          while ((word = words.pop())) {
            line.push(word);
            tspan.text(line.join(" "));
            if (tspan.node().getComputedTextLength() > maxWidth) {
              line.pop();
              tspan.text(line.join(" "));
              line = [word];
              tspan = roleText.append("tspan").attr("x", 16).attr("dy", lineHeight + "em").text(word);
            }
          }
        });

        // Departamento con color correspondiente
        node.filter(d => d.data.department).append("text")
          .attr("y", (CARD_HEIGHT / 2) - 14)
          .attr("x", 16)
          .text(d => d.data.department.toUpperCase())
          .attr("class", "text-[10px] font-bold tracking-wider")
          .attr("fill", d => departmentColors[d.data.department] || '#0071B9');

        // Indicador de reportes directos
        node.filter(d => d.children && d.children.length > 0).append("g")
          .attr("transform", `translate(${CARD_WIDTH - 30}, 0)`)
          .call(g => {
            g.append("circle")
              .attr("r", 14)
              .attr("fill", "#0071B9")
              .attr("stroke", "#ffffff")
              .attr("stroke-width", 2);
            g.append("text")
              .attr("text-anchor", "middle")
              .attr("dy", "0.35em")
              .attr("class", "text-xs font-bold")
              .attr("fill", "#ffffff")
              .text(d => d.children.length);
          });
      }

      // B√∫squeda
      document.getElementById('searchInput').addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase().trim();
        
        d3.selectAll('.node-card').classed('highlighted', false);
        
        if (searchTerm === '') return;
        
        d3.selectAll('.node-group').each(function(d) {
          const matches = 
            d.data.name.toLowerCase().includes(searchTerm) ||
            d.data.role.toLowerCase().includes(searchTerm) ||
            (d.data.department && d.data.department.toLowerCase().includes(searchTerm));
          
          if (matches) {
            d3.select(this).select('.node-card').classed('highlighted', true);
          }
        });
      });

      // Filtro por departamento
      function filterDept(dept) {
        currentFilter = dept;
        
        document.querySelectorAll('.dept-btn').forEach(btn => {
          btn.classList.remove('btn-mondraker');
          btn.classList.add('btn-secondary');
        });
        event.target.classList.remove('btn-secondary');
        event.target.classList.add('btn-mondraker');
        
        const filtered = dept === 'all' 
          ? allData 
          : allData.filter(p => p.department === dept);
        
        document.getElementById('employeeCount').innerHTML = 
          `<span class="text-black font-bold">${filtered.length}</span> <span class="text-gray-500">of ${allData.length} employees</span>`;
        
        renderChart(filtered);
      }

      // Modal de detalles
      function showModal(data) {
        // Paleta de colores por departamento (igual que en las tarjetas)
        const departmentColors = {
          'Producto': '#0071B9',
          'RRHH': '#10b981',
          'FINANCE': '#f59e0b',
          'MARKETING': '#ec4899',
          'OPERATIONS': '#8b5cf6',
          'WAREHOUSE': '#06b6d4',
          'PRODUCTION': '#ef4444',
          'IT': '#6366f1',
          'SALES': '#14b8a6',
          'CUSTOMER SERVICE': '#f97316'
        };
        
        document.getElementById('modalName').textContent = data.name;
        document.getElementById('modalRole').textContent = data.role;
        
        const deptElement = document.getElementById('modalDept');
        deptElement.textContent = data.department || 'N/A';
        // Aplicar color correspondiente al departamento
        deptElement.style.color = departmentColors[data.department] || '#0071B9';
        
        if (data.email) {
          document.getElementById('modalEmailSection').classList.remove('hidden');
          document.getElementById('modalEmail').textContent = data.email;
          document.getElementById('modalEmail').href = `mailto:${data.email}`;
        } else {
          document.getElementById('modalEmailSection').classList.add('hidden');
        }
        
        if (data.phone) {
          document.getElementById('modalPhoneSection').classList.remove('hidden');
          document.getElementById('modalPhone').textContent = data.phone;
        } else {
          document.getElementById('modalPhoneSection').classList.add('hidden');
        }
        
        const reports = data.children ? data.children.length : 0;
        document.getElementById('modalReports').textContent = reports === 0 ? 'None' : reports;
        
        document.getElementById('modal').classList.remove('hidden');
      }

      function closeModal(event) {
        if (!event || event.target.id === 'modal') {
          document.getElementById('modal').classList.add('hidden');
        }
      }

      // Controles de zoom
      function resetZoom() {
        // El nodo ra√≠z (CEO) est√° en (0, 0) en coordenadas del SVG
        // El viewBox [-width/2, -height/2, width, height] ya centra el origen en la pantalla
        // Solo necesitamos aplicar un scale sin translate adicional
        
        const scale = 0.7;
        
        svg.transition()
          .duration(750)
          .call(
            zoom.transform,
            d3.zoomIdentity.scale(scale)
          );
      }

      function zoomIn() {
        svg.transition().duration(300).call(zoom.scaleBy, 1.3);
      }

      function zoomOut() {
        svg.transition().duration(300).call(zoom.scaleBy, 0.7);
      }

      // ============================================
      // FUNCIONES DE EXPORTACI√ìN
      // ============================================
      
      // Toggle dropdown del men√∫ de exportaci√≥n
      function toggleDropdown(event) {
        event.stopPropagation();
        const dropdown = document.getElementById('exportDropdown');
        dropdown.classList.toggle('show');
      }

      // Cerrar dropdown si se hace click fuera
      window.onclick = function(event) {
        if (!event.target.matches('.btn-export') && !event.target.closest('.btn-export')) {
          const dropdowns = document.getElementsByClassName("dropdown-content");
          for (let i = 0; i < dropdowns.length; i++) {
            const openDropdown = dropdowns[i];
            if (openDropdown.classList.contains('show')) {
              openDropdown.classList.remove('show');
            }
          }
        }
      }
      
      async function exportToPNG() {
        try {
          // Cerrar el dropdown
          document.getElementById('exportDropdown').classList.remove('show');
          
          document.getElementById('exportingOverlay').classList.remove('hidden');
          
          await new Promise(resolve => setTimeout(resolve, 100));
          
          // Obtener todos los elementos g visibles (no display:none)
          const visibleNodes = g.selectAll('g').filter(function() {
            return this.style.display !== 'none';
          });
          
          // Calcular bounding box solo de nodos visibles
          let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
          
          visibleNodes.each(function() {
            const bbox = this.getBBox();
            const transform = this.getAttribute('transform');
            let x = 0, y = 0;
            
            if (transform) {
              const match = transform.match(/translate\(([^,]+),([^)]+)\)/);
              if (match) {
                x = parseFloat(match[1]);
                y = parseFloat(match[2]);
              }
            }
            
            minX = Math.min(minX, x);
            minY = Math.min(minY, y - CARD_HEIGHT/2);
            maxX = Math.max(maxX, x + CARD_WIDTH);
            maxY = Math.max(maxY, y + CARD_HEIGHT/2);
          });
          
          // A√±adir margen
          const margin = 100;
          minX -= margin;
          minY -= margin;
          maxX += margin;
          maxY += margin;
          
          const exportWidth = maxX - minX;
          const exportHeight = maxY - minY;
          
          // Crear un contenedor temporal para exportaci√≥n
          const tempContainer = document.createElement('div');
          tempContainer.style.position = 'absolute';
          tempContainer.style.left = '-9999px';
          tempContainer.style.width = '1920px';
          tempContainer.style.height = '1080px';
          tempContainer.style.backgroundColor = '#ffffff';
          document.body.appendChild(tempContainer);
          
          // Crear SVG temporal con viewBox ajustado al contenido visible
          const tempSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
          tempSvg.setAttribute('width', '1920');
          tempSvg.setAttribute('height', '1080');
          tempSvg.setAttribute('viewBox', `${minX} ${minY} ${exportWidth} ${exportHeight}`);
          tempSvg.style.backgroundColor = '#ffffff';
          
          // Copiar los estilos necesarios
          const styleElement = document.createElementNS('http://www.w3.org/2000/svg', 'style');
          styleElement.textContent = `
            text { font-family: 'Inter', sans-serif; }
            .node-card { cursor: pointer; }
          `;
          tempSvg.appendChild(styleElement);
          
          // Clonar el grupo g con todo el contenido
          const clonedG = g.node().cloneNode(true);
          tempSvg.appendChild(clonedG);
          
          tempContainer.appendChild(tempSvg);
          
          await new Promise(resolve => setTimeout(resolve, 300));
          
          // Capturar el contenedor temporal
          const canvas = await html2canvas(tempContainer, {
            backgroundColor: '#ffffff',
            scale: 2,
            logging: false,
            width: 1920,
            height: 1080
          });
          
          // Limpiar
          document.body.removeChild(tempContainer);
          
          // Descargar imagen
          const link = document.createElement('a');
          const timestamp = new Date().toISOString().split('T')[0];
          link.download = `Mondraker_Organizational_Chart_${timestamp}.png`;
          link.href = canvas.toDataURL('image/png');
          link.click();
          
          document.getElementById('exportingOverlay').classList.add('hidden');
        } catch (error) {
          console.error('Error exporting PNG:', error);
          alert('Error exporting chart. Please try again.');
          document.getElementById('exportingOverlay').classList.add('hidden');
        }
      }

      async function exportToPDF() {
        try {
          // Cerrar el dropdown
          document.getElementById('exportDropdown').classList.remove('show');
          
          document.getElementById('exportingOverlay').classList.remove('hidden');
          
          await new Promise(resolve => setTimeout(resolve, 100));
          
          // Obtener todos los elementos g visibles (no display:none)
          const visibleNodes = g.selectAll('g').filter(function() {
            return this.style.display !== 'none';
          });
          
          // Calcular bounding box solo de nodos visibles
          let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
          
          visibleNodes.each(function() {
            const bbox = this.getBBox();
            const transform = this.getAttribute('transform');
            let x = 0, y = 0;
            
            if (transform) {
              const match = transform.match(/translate\(([^,]+),([^)]+)\)/);
              if (match) {
                x = parseFloat(match[1]);
                y = parseFloat(match[2]);
              }
            }
            
            minX = Math.min(minX, x);
            minY = Math.min(minY, y - CARD_HEIGHT/2);
            maxX = Math.max(maxX, x + CARD_WIDTH);
            maxY = Math.max(maxY, y + CARD_HEIGHT/2);
          });
          
          // A√±adir margen
          const margin = 100;
          minX -= margin;
          minY -= margin;
          maxX += margin;
          maxY += margin;
          
          const exportWidth = maxX - minX;
          const exportHeight = maxY - minY;
          
          // Crear un contenedor temporal para exportaci√≥n
          const tempContainer = document.createElement('div');
          tempContainer.style.position = 'absolute';
          tempContainer.style.left = '-9999px';
          tempContainer.style.width = '1920px';
          tempContainer.style.height = '1080px';
          tempContainer.style.backgroundColor = '#ffffff';
          document.body.appendChild(tempContainer);
          
          // Crear SVG temporal con viewBox ajustado al contenido visible
          const tempSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
          tempSvg.setAttribute('width', '1920');
          tempSvg.setAttribute('height', '1080');
          tempSvg.setAttribute('viewBox', `${minX} ${minY} ${exportWidth} ${exportHeight}`);
          tempSvg.style.backgroundColor = '#ffffff';
          
          // Copiar los estilos necesarios
          const styleElement = document.createElementNS('http://www.w3.org/2000/svg', 'style');
          styleElement.textContent = `
            text { font-family: 'Inter', sans-serif; }
            .node-card { cursor: pointer; }
          `;
          tempSvg.appendChild(styleElement);
          
          // Clonar el grupo g con todo el contenido
          const clonedG = g.node().cloneNode(true);
          tempSvg.appendChild(clonedG);
          
          tempContainer.appendChild(tempSvg);
          
          await new Promise(resolve => setTimeout(resolve, 300));
          
          // Capturar el contenedor temporal
          const canvas = await html2canvas(tempContainer, {
            backgroundColor: '#ffffff',
            scale: 2,
            logging: false,
            width: 1920,
            height: 1080
          });
          
          // Limpiar
          document.body.removeChild(tempContainer);
          
          const imgData = canvas.toDataURL('image/png');
          const { jsPDF } = window.jspdf;
          
          // Determinar orientaci√≥n seg√∫n el aspect ratio
          const aspectRatio = exportWidth / exportHeight;
          const orientation = aspectRatio > 1.3 ? 'landscape' : 'portrait';
          
          // Crear PDF
          const pdf = new jsPDF({
            orientation: orientation,
            unit: 'mm',
            format: 'a3'
          });
          
          const pdfWidth = pdf.internal.pageSize.getWidth();
          const pdfHeight = pdf.internal.pageSize.getHeight();
          
          // Calcular dimensiones manteniendo aspect ratio
          let imgWidth = pdfWidth - 20; // margen de 10mm a cada lado
          let imgHeight = (canvas.height / canvas.width) * imgWidth;
          
          // Si la altura es mayor que la p√°gina, ajustar por altura
          if (imgHeight > pdfHeight - 20) {
            imgHeight = pdfHeight - 20;
            imgWidth = (canvas.width / canvas.height) * imgHeight;
          }
          
          // Centrar en la p√°gina
          const x = (pdfWidth - imgWidth) / 2;
          const y = (pdfHeight - imgHeight) / 2;
          
          pdf.addImage(imgData, 'PNG', x, y, imgWidth, imgHeight);
          
          const timestamp = new Date().toISOString().split('T')[0];
          pdf.save(`Mondraker_Organizational_Chart_${timestamp}.pdf`);
          
          document.getElementById('exportingOverlay').classList.add('hidden');
        } catch (error) {
          console.error('Error exporting PDF:', error);
          alert('Error exporting chart. Please try again.');
          document.getElementById('exportingOverlay').classList.add('hidden');
        }
      }

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeModal();
      });

      // Funci√≥n de inicializaci√≥n de la aplicaci√≥n
      function initializeApp() {
        console.log('üöÄ Starting Mondraker Organizational Chart...');
        
        // Verificaci√≥n final de librer√≠as
        if (typeof d3 === 'undefined') {
          console.error('‚ùå D3 is not available');
          document.getElementById('employeeCount').innerHTML = 
            '<span class="text-red-500">‚ö†Ô∏è Error: D3 library not loaded</span>';
          return;
        }
        
        if (typeof html2canvas === 'undefined') {
          console.warn('‚ö†Ô∏è html2canvas not available - Export to PNG will not work');
        }
        
        if (typeof window.jspdf === 'undefined') {
          console.warn('‚ö†Ô∏è jsPDF not available - Export to PDF will not work');
        }
        
        // Iniciar carga de datos
        loadData();
      }

      // Fallback: Si las librer√≠as ya estaban cargadas cuando llegamos aqu√≠
      if (typeof d3 !== 'undefined' && typeof html2canvas !== 'undefined' && typeof window.jspdf !== 'undefined') {
        console.log('‚úÖ Libraries already loaded, initializing immediately');
        initializeApp();
      }
    </script>
</body>
</html>
