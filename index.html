<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mondraker Organizational Chart</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
      
      * {
        box-sizing: border-box;
      }
      
      body { 
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background: #ffffff;
        overflow: hidden; 
        margin: 0;
        padding: 0;
      }
      
      /* Pantalla de login */
      .login-screen {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, #000000 0%, #1a1a2e 50%, #0071B9 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
      }
      
      .login-box {
        background: white;
        border-radius: 16px;
        padding: 40px;
        width: 90%;
        max-width: 360px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        text-align: center;
      }
      
      .login-input {
        width: 100%;
        padding: 14px 20px;
        border: 2px solid #e2e3e4;
        border-radius: 8px;
        font-size: 16px;
        transition: all 0.3s;
        text-align: center;
        letter-spacing: 2px;
      }
      
      .login-input:focus {
        outline: none;
        border-color: #0071B9;
        box-shadow: 0 0 0 3px rgba(0, 113, 185, 0.1);
      }
      
      .login-input.error {
        border-color: #ef4444;
        animation: shake 0.5s;
      }
      
      @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-10px); }
        75% { transform: translateX(10px); }
      }
      
      /* Capas SVG */
      .links-layer { pointer-events: none; }
      
      .node-card { 
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
      }
      
      .node-card:hover { 
        filter: drop-shadow(0 8px 16px rgba(0, 113, 185, 0.3));
      }
      
      .node-card.highlighted { 
        stroke: #0071B9;
        stroke-width: 3;
        filter: drop-shadow(0 0 20px rgba(0, 113, 185, 0.8));
        animation: pulse 2s infinite;
      }
      
      @keyframes pulse {
        0%, 100% { filter: drop-shadow(0 0 20px rgba(0, 113, 185, 0.8)); }
        50% { filter: drop-shadow(0 0 30px rgba(0, 113, 185, 1)); }
      }
      
      .search-input {
        transition: all 0.3s;
        border: 2px solid #e2e3e4;
        background: #ffffff;
        color: #000000;
      }
      
      .search-input:focus {
        border-color: #0071B9;
        box-shadow: 0 0 0 3px rgba(0, 113, 185, 0.1);
        outline: none;
      }
      
      .search-input::placeholder { color: #999; }
      
      #modal { 
        backdrop-filter: blur(10px);
        background: rgba(0, 0, 0, 0.5);
      }
      
      .modal-content {
        max-height: 90vh;
        overflow-y: auto;
      }
      
      .fade-in { 
        animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      @keyframes fadeIn { 
        from { opacity: 0; transform: translateY(-20px) scale(0.95); } 
        to { opacity: 1; transform: translateY(0) scale(1); } 
      }
      
      .btn-mondraker {
        background: #0071B9;
        transition: all 0.3s;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .btn-mondraker:hover {
        background: #005a94;
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 113, 185, 0.4);
      }
      
      .btn-secondary {
        background: #e2e3e4;
        color: #000000;
        transition: all 0.3s;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .btn-secondary:hover {
        background: #d0d1d2;
        transform: translateY(-1px);
      }
      
      .btn-export {
        background: #ffffff;
        border: 2px solid #0071B9;
        color: #0071B9;
        transition: all 0.3s;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .btn-export:hover {
        background: #0071B9;
        color: #ffffff;
        transform: translateY(-2px);
      }
      
      .btn-icon {
        background: #e2e3e4;
        color: #000000;
        transition: all 0.3s;
        font-weight: 700;
        min-width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 6px;
        font-size: 12px;
        padding: 0 8px;
      }
      
      .btn-icon:hover {
        background: #0071B9;
        color: white;
        transform: translateY(-1px);
      }
      
      .btn-icon.active {
        background: #0071B9;
        color: white;
      }
      
      .logo-mondraker {
        font-weight: 800;
        letter-spacing: -0.5px;
        color: #000000;
      }
      
      .loading {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(0, 113, 185, 0.3);
        border-radius: 50%;
        border-top-color: #0071B9;
        animation: spin 1s ease-in-out infinite;
      }
      
      @keyframes spin { to { transform: rotate(360deg); } }

      /* Dropdown mejorado */
      .dropdown {
        position: relative;
        display: inline-block;
      }

      .dropdown-content {
        display: none;
        position: absolute;
        background-color: #ffffff;
        min-width: 180px;
        box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.15);
        z-index: 100;
        border: 2px solid #e2e3e4;
        border-radius: 8px;
        margin-top: 4px;
        max-height: 300px;
        overflow-y: auto;
      }

      .dropdown-content button {
        color: #000000;
        padding: 8px 12px;
        text-decoration: none;
        display: block;
        width: 100%;
        text-align: left;
        border: none;
        background: none;
        cursor: pointer;
        font-size: 11px;
        font-weight: 600;
        transition: all 0.2s;
      }

      .dropdown-content button:hover {
        background-color: #0071B9;
        color: #ffffff;
      }

      .dropdown-content.show { display: block; }

      #exportingOverlay {
        backdrop-filter: blur(5px);
        background: rgba(255, 255, 255, 0.9);
      }
      
      /* Multi-select dropdown para departamentos */
      .dept-dropdown {
        position: relative;
        display: inline-block;
      }
      
      .dept-dropdown-btn {
        background: #e2e3e4;
        padding: 6px 28px 6px 10px;
        border: none;
        border-radius: 6px;
        font-size: 10px;
        font-weight: 700;
        text-transform: uppercase;
        cursor: pointer;
        transition: all 0.3s;
        white-space: nowrap;
        position: relative;
      }
      
      .dept-dropdown-btn::after {
        content: '‚ñº';
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 8px;
      }
      
      .dept-dropdown-btn:hover {
        background-color: #d0d1d2;
      }
      
      .dept-dropdown-content {
        display: none;
        position: absolute;
        background-color: #ffffff;
        min-width: 200px;
        max-height: 280px;
        overflow-y: auto;
        box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.15);
        z-index: 100;
        border: 2px solid #e2e3e4;
        border-radius: 8px;
        margin-top: 4px;
        padding: 6px 0;
      }
      
      .dept-dropdown-content.show { display: block; }
      
      .dept-option {
        display: flex;
        align-items: center;
        padding: 8px 12px;
        cursor: pointer;
        font-size: 11px;
        font-weight: 500;
        transition: background 0.2s;
      }
      
      .dept-option:hover {
        background-color: #f3f4f6;
      }
      
      .dept-option input {
        margin-right: 8px;
        accent-color: #0071B9;
        width: 14px;
        height: 14px;
      }
      
      .dept-option.all-option {
        border-bottom: 1px solid #e2e3e4;
        margin-bottom: 4px;
        padding-bottom: 10px;
        font-weight: 700;
      }
      
      /* Descripci√≥n del puesto con scroll */
      .description-box {
        max-height: 400px;
        overflow-y: auto;
        padding-right: 8px;
      }
      
      .description-box::-webkit-scrollbar {
        width: 6px;
      }
      
      .description-box::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
      }
      
      .description-box::-webkit-scrollbar-thumb {
        background: #0071B9;
        border-radius: 3px;
      }
      
      /* Header compacto para m√≥vil */
      .header-compact {
        padding: 8px 12px;
      }
      
      @media (max-width: 768px) {
        .header-compact {
          padding: 6px 8px;
        }
        
        .hide-mobile {
          display: none !important;
        }
        
        .logo-mondraker {
          font-size: 16px;
        }
        
        .btn-icon {
          min-width: 28px;
          height: 28px;
          font-size: 11px;
        }
        
        .search-input {
          padding: 6px 10px;
          font-size: 11px;
        }
        
        .dept-dropdown-btn {
          font-size: 9px;
          padding: 5px 22px 5px 8px;
        }
        
        #chart-container {
          padding-top: 52px !important;
        }
        
        .modal-content {
          padding: 16px;
          margin: 8px;
        }
        
        .modal-content h2 {
          font-size: 18px;
        }
      }
      
      @media (max-width: 480px) {
        .search-mobile-hidden {
          display: none;
        }
        
        #chart-container {
          padding-top: 48px !important;
        }
      }
    </style>
</head>
<body class="w-screen h-screen">
    <!-- ================================ -->
    <!-- PANTALLA DE LOGIN (CONTRASE√ëA)  -->
    <!-- ================================ -->
    <div id="loginScreen" class="login-screen">
      <div class="login-box">
        <div class="mb-6">
          <h1 class="logo-mondraker text-2xl mb-2">MONDRAKER</h1>
          <p class="text-gray-500 text-sm">Organizational Chart</p>
        </div>
        <div class="mb-4">
          <p class="text-gray-600 text-sm mb-3">Enter access password</p>
          <input 
            type="password" 
            id="passwordInput" 
            class="login-input" 
            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            autocomplete="off"
          />
          <p id="loginError" class="text-red-500 text-sm mt-2 hidden">Incorrect password</p>
        </div>
        <button onclick="checkPassword()" class="btn-mondraker w-full py-3 rounded-lg text-white text-sm mt-4">
          ACCESS
        </button>
        <p class="text-gray-400 text-xs mt-6">Internal access only</p>
      </div>
    </div>

    <!-- ================================ -->
    <!-- APLICACI√ìN PRINCIPAL            -->
    <!-- ================================ -->
    <div id="mainApp" class="hidden">
      <!-- Overlay de exportaci√≥n -->
      <div id="exportingOverlay" class="hidden fixed inset-0 z-[100] flex items-center justify-center">
        <div class="bg-white border-2 border-blue-500 rounded-2xl p-6 text-center shadow-2xl">
          <div class="loading mx-auto mb-3" style="width: 32px; height: 32px; border-width: 3px;"></div>
          <p class="text-black text-base font-bold">Exporting...</p>
        </div>
      </div>

      <!-- Panel de Control Superior ULTRA COMPACTO -->
      <div class="absolute top-0 left-0 right-0 z-50 bg-white border-b border-gray-200 shadow-sm header-compact">
        <div class="flex items-center justify-between gap-2">
          <!-- Logo -->
          <div class="flex items-center gap-2 flex-shrink-0">
            <h1 class="logo-mondraker text-lg">MONDRAKER</h1>
          </div>
          
          <!-- B√∫squeda compacta - oculta en m√≥vil muy peque√±o -->
          <div class="flex-1 max-w-[180px] search-mobile-hidden">
            <input 
              type="text" 
              id="searchInput" 
              placeholder="üîç Search..." 
              class="search-input w-full px-2 py-1.5 rounded text-xs"
            />
          </div>
          
          <!-- Controles -->
          <div class="flex items-center gap-1 flex-shrink-0">
            <!-- Dropdown de departamentos din√°mico -->
            <div class="dept-dropdown">
              <button onclick="toggleDeptDropdown(event)" class="dept-dropdown-btn" id="deptDropdownBtn">
                ALL DEPTS
              </button>
              <div id="deptDropdownContent" class="dept-dropdown-content">
                <!-- Se llena din√°micamente -->
              </div>
            </div>
            
            <!-- Separador -->
            <div class="w-px h-5 bg-gray-300 mx-0.5 hide-mobile"></div>
            
            <!-- Orientaci√≥n -->
            <button onclick="toggleOrientation()" id="orientationBtn" class="btn-icon" title="Toggle orientation">
              ‚ÜîÔ∏è
            </button>
            
            <!-- Zoom -->
            <button onclick="zoomOut()" class="btn-icon hide-mobile" title="Zoom out">‚ûñ</button>
            <button onclick="zoomIn()" class="btn-icon hide-mobile" title="Zoom in">‚ûï</button>
            <button onclick="resetZoom()" class="btn-icon" title="Reset">üè†</button>
            
            <!-- Separador -->
            <div class="w-px h-5 bg-gray-300 mx-0.5 hide-mobile"></div>
            
            <!-- Contador -->
            <div class="text-gray-600 text-xs hide-mobile">
              <span id="employeeCount"><span class="loading"></span></span>
            </div>
            
            <!-- Export -->
            <div class="dropdown">
              <button onclick="toggleDropdown(event)" class="btn-export px-2 py-1.5 rounded text-xs flex items-center gap-1">
                üì•
                <span class="text-xs">‚ñº</span>
              </button>
              <div id="exportDropdown" class="dropdown-content" style="right: 0;">
                <button onclick="exportToPNG()">üì∑ PNG</button>
                <button onclick="exportToPDF()">üìÑ PDF</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Contenedor del Organigrama - altura completa menos header -->
      <div id="chart-container" class="w-full h-full pt-14"></div>

      <!-- Modal de Detalles -->
      <div id="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-2 md:p-4" onclick="closeModal(event)">
        <div class="modal-content bg-white border-2 border-gray-200 rounded-2xl shadow-2xl max-w-4xl w-full p-6 md:p-8 fade-in" onclick="event.stopPropagation()">
          <div class="flex justify-between items-start mb-4 md:mb-6">
            <div class="flex items-center gap-3 md:gap-4">
              <!-- Foto del empleado -->
              <div id="modalPhoto" class="w-16 h-16 md:w-24 md:h-24 rounded-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center overflow-hidden border-4 border-white shadow-lg flex-shrink-0">
                <span id="modalInitials" class="text-xl md:text-3xl font-bold text-gray-400"></span>
                <img id="modalPhotoImg" class="hidden w-full h-full object-cover" src="" alt="">
              </div>
              <div>
                <h2 id="modalName" class="text-xl md:text-2xl font-bold text-black mb-1"></h2>
                <p id="modalRoleHeader" class="text-xs md:text-sm text-gray-600"></p>
                <div class="h-1 w-16 md:w-20 bg-gradient-to-r from-blue-500 to-transparent mt-2"></div>
              </div>
            </div>
            <button onclick="closeModal()" class="text-gray-400 hover:text-black text-2xl md:text-3xl transition flex-shrink-0">&times;</button>
          </div>
          
          <div class="space-y-2 md:space-y-3">
            <div class="grid grid-cols-2 gap-2 md:gap-3">
              <div class="bg-gray-50 rounded-lg p-3 md:p-4 border border-gray-200">
                <p class="text-[10px] md:text-xs text-gray-500 uppercase tracking-wider mb-1 font-semibold">Department</p>
                <p id="modalDept" class="text-sm md:text-base font-bold text-blue-600"></p>
              </div>
              
              <div class="bg-gray-50 rounded-lg p-3 md:p-4 border border-gray-200">
                <p class="text-[10px] md:text-xs text-gray-500 uppercase tracking-wider mb-1 font-semibold">Direct Reports</p>
                <p id="modalReports" class="text-sm md:text-base font-bold text-black"></p>
              </div>
            </div>
            
            <div id="modalEmailSection" class="bg-gray-50 rounded-lg p-3 md:p-4 border border-gray-200 hidden">
              <p class="text-[10px] md:text-xs text-gray-500 uppercase tracking-wider mb-1 font-semibold">Email</p>
              <a id="modalEmail" href="#" class="text-sm md:text-base font-semibold text-blue-600 hover:text-blue-700 transition break-all"></a>
            </div>
            
            <div id="modalPhoneSection" class="bg-gray-50 rounded-lg p-3 md:p-4 border border-gray-200 hidden">
              <p class="text-[10px] md:text-xs text-gray-500 uppercase tracking-wider mb-1 font-semibold">Phone</p>
              <p id="modalPhone" class="text-sm md:text-base font-semibold text-black"></p>
            </div>
            
            <!-- Descripci√≥n del puesto -->
            <div id="modalDescSection" class="bg-blue-50 rounded-lg p-3 md:p-4 border border-blue-200 hidden">
              <p class="text-[10px] md:text-xs text-blue-600 uppercase tracking-wider mb-2 font-semibold">Job Description</p>
              <div class="description-box">
                <p id="modalDesc" class="text-xs md:text-sm text-gray-700 leading-relaxed whitespace-pre-line"></p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sistema de carga de librer√≠as -->
    <script>
      (function() {
        let scriptsLoaded = { d3: false, jspdf: false };
        
        const cdnOptions = {
          d3: [
            'https://d3js.org/d3.v7.min.js',
            'https://cdn.jsdelivr.net/npm/d3@7/dist/d3.min.js',
            'https://unpkg.com/d3@7/dist/d3.min.js'
          ],
          jspdf: [
            'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
            'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js',
            'https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js'
          ]
        };
        
        function checkAllLoaded() {
          return scriptsLoaded.d3 && scriptsLoaded.jspdf;
        }
        
        function tryInitialize() {
          if (checkAllLoaded() && typeof initializeApp === 'function') {
            console.log('‚úÖ All libraries loaded!');
            initializeApp();
          }
        }
        
        function loadScriptWithFallback(name, urls, index = 0) {
          if (index >= urls.length) {
            console.error(`‚ùå Failed to load ${name}`);
            return;
          }
          
          const script = document.createElement('script');
          script.src = urls[index];
          
          script.onload = function() {
            scriptsLoaded[name] = true;
            tryInitialize();
          };
          
          script.onerror = function() {
            setTimeout(() => loadScriptWithFallback(name, urls, index + 1), 500);
          };
          
          document.body.appendChild(script);
        }
        
        loadScriptWithFallback('d3', cdnOptions.d3);
        loadScriptWithFallback('jspdf', cdnOptions.jspdf);
      })();
    </script>

    <script>
      // ============================================
      // SISTEMA DE AUTENTICACI√ìN
      // ============================================
      const ACCESS_PASSWORD = 'gravel';
      
      function checkPassword() {
        const input = document.getElementById('passwordInput');
        const error = document.getElementById('loginError');
        
        if (input.value.toLowerCase() === ACCESS_PASSWORD) {
          document.getElementById('loginScreen').style.display = 'none';
          document.getElementById('mainApp').classList.remove('hidden');
          sessionStorage.setItem('mondraker_auth', 'true');
        } else {
          input.classList.add('error');
          error.classList.remove('hidden');
          setTimeout(() => input.classList.remove('error'), 500);
        }
      }
      
      document.getElementById('passwordInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') checkPassword();
      });
      
      if (sessionStorage.getItem('mondraker_auth') === 'true') {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('mainApp').classList.remove('hidden');
      }

      // ============================================
      // CONFIGURACI√ìN
      // ============================================
      const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyxZ8ZW6fpynxQfcUBzckrooqlo28-QUYI8Z0Mix6IbdJh_98QOGx2ICDsy6NTecpPJ/exec?key=MONDRAKER_ORG_2026.02_script';

      // Variables globales
      let allData = [];
      let allDepartments = [];
      let selectedDepartments = new Set(['all']);
      let currentOrientation = 'horizontal';
      let svg, g, zoom, root, tree;
      
      const CARD_WIDTH = 220;
      const CARD_HEIGHT = 80;
      const width = window.innerWidth;
      const height = window.innerHeight;

      // Colores por departamento
      const departmentColors = {
        'Producto': '#0071B9',
        'RRHH': '#10b981',
        'FINANCE': '#f59e0b',
        'MARKETING': '#ec4899',
        'OPERATIONS': '#8b5cf6',
        'WAREHOUSE': '#06b6d4',
        'PRODUCTION': '#ef4444',
        'IT': '#6366f1',
        'SALES': '#14b8a6',
        'CUSTOMER SERVICE': '#f97316',
        'DIRECCI√ìN': '#1f2937'
      };

      // ============================================
      // FUNCIONES DE DATOS
      // ============================================
      
      function buildHierarchy(flatData) {
        const map = {};
        const roots = [];
        
        flatData.forEach(person => {
          map[person.id] = {
            id: person.id,
            name: person.name,
            role: person.role,
            department: person.department,
            email: person.email || '',
            phone: person.phone || '',
            photo: person.photo || '',
            description: person.description || '',
            children: []
          };
        });
        
        flatData.forEach(person => {
          if (person.manager_id && map[person.manager_id]) {
            map[person.manager_id].children.push(map[person.id]);
          } else {
            roots.push(map[person.id]);
          }
        });
        
        return roots.length === 1 ? roots[0] : { 
          id: "root", name: "Organization", role: "", department: "", children: roots 
        };
      }

      async function loadData() {
        try {
          console.log('üîÑ Loading data...');
          const response = await fetch(APPS_SCRIPT_URL);
          
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
          
          const data = await response.json();
          
          if (data.error) throw new Error(data.error);
          
          allData = data;
          
          // Extraer departamentos √∫nicos del Sheet
          allDepartments = [...new Set(data.map(p => p.department).filter(d => d && d.trim() !== ''))].sort();
          
          // Construir el dropdown de departamentos
          buildDepartmentDropdown();
          
          initializeChart();
        } catch (error) {
          console.error('‚ùå Error:', error);
          document.getElementById('employeeCount').innerHTML = 
            '<span class="text-red-500">‚ö†Ô∏è Error</span>';
        }
      }

      // ============================================
      // DROPDOWN DE DEPARTAMENTOS DIN√ÅMICO
      // ============================================
      
      function buildDepartmentDropdown() {
        const container = document.getElementById('deptDropdownContent');
        container.innerHTML = '';
        
        // Opci√≥n "Todos"
        const allOption = document.createElement('label');
        allOption.className = 'dept-option all-option';
        allOption.innerHTML = `
          <input type="checkbox" id="dept-all" checked onchange="handleDeptChange('all', this.checked)">
          <span>ALL DEPARTMENTS</span>
        `;
        container.appendChild(allOption);
        
        // Opciones de cada departamento
        allDepartments.forEach(dept => {
          const option = document.createElement('label');
          option.className = 'dept-option';
          option.innerHTML = `
            <input type="checkbox" id="dept-${dept}" onchange="handleDeptChange('${dept}', this.checked)">
            <span style="color: ${departmentColors[dept] || '#333'}">${dept}</span>
          `;
          container.appendChild(option);
        });
      }
      
      function toggleDeptDropdown(event) {
        event.stopPropagation();
        document.getElementById('deptDropdownContent').classList.toggle('show');
        // Cerrar otros dropdowns
        document.getElementById('exportDropdown').classList.remove('show');
      }
      
      function handleDeptChange(dept, checked) {
        if (dept === 'all') {
          if (checked) {
            // Seleccionar "todos" desmarca los individuales
            selectedDepartments = new Set(['all']);
            allDepartments.forEach(d => {
              const cb = document.getElementById(`dept-${d}`);
              if (cb) cb.checked = false;
            });
          } else {
            // No permitir desmarcar "todos" si no hay nada seleccionado
            document.getElementById('dept-all').checked = true;
          }
        } else {
          // Desmarcar "todos" al seleccionar individual
          document.getElementById('dept-all').checked = false;
          selectedDepartments.delete('all');
          
          if (checked) {
            selectedDepartments.add(dept);
          } else {
            selectedDepartments.delete(dept);
          }
          
          // Si no queda nada seleccionado, volver a "todos"
          if (selectedDepartments.size === 0) {
            selectedDepartments.add('all');
            document.getElementById('dept-all').checked = true;
          }
        }
        
        updateDeptButtonText();
        applyFilter();
      }
      
      function updateDeptButtonText() {
        const btn = document.getElementById('deptDropdownBtn');
        if (selectedDepartments.has('all')) {
          btn.textContent = 'ALL DEPTS';
        } else if (selectedDepartments.size === 1) {
          const dept = [...selectedDepartments][0];
          btn.textContent = dept.length > 12 ? dept.substring(0, 10) + '...' : dept;
        } else {
          btn.textContent = `${selectedDepartments.size} DEPTS`;
        }
      }
      
      function applyFilter() {
        let filtered;
        
        if (selectedDepartments.has('all')) {
          filtered = allData;
        } else {
          filtered = allData.filter(p => selectedDepartments.has(p.department));
        }
        
        document.getElementById('employeeCount').innerHTML = 
          `<span class="font-bold">${filtered.length}</span>/${allData.length}`;
        
        renderChart(filtered);
        resetZoom();
      }

      // ============================================
      // FUNCIONES DEL ORGANIGRAMA
      // ============================================
      
      function initializeChart() {
        document.getElementById('employeeCount').innerHTML = 
          `<span class="font-bold">${allData.length}</span> emp.`;
        
        svg = d3.select("#chart-container").append("svg")
          .attr("viewBox", [-width / 2, -height / 2, width, height])
          .style("width", "100%")
          .style("height", "100%");

        g = svg.append("g");
        
        zoom = d3.zoom()
          .scaleExtent([0.1, 4])
          .on("zoom", (e) => g.attr("transform", e.transform));
        
        svg.call(zoom);
        
        renderChart(allData);
        resetZoom();
      }

      function renderChart(data) {
        g.selectAll("*").remove();
        
        const hierarchyData = buildHierarchy(data);
        root = d3.hierarchy(hierarchyData);
        
        // Espaciado seg√∫n orientaci√≥n - VERTICAL M√ÅS COMPACTO HORIZONTALMENTE
        let nodeSpacingX, nodeSpacingY;
        
        if (currentOrientation === 'horizontal') {
          nodeSpacingX = CARD_HEIGHT + 35;
          nodeSpacingY = CARD_WIDTH + 80;
          tree = d3.tree().nodeSize([nodeSpacingX, nodeSpacingY]);
        } else {
          // Vertical: espacio suficiente para evitar solapamiento
          nodeSpacingX = CARD_WIDTH + 50;   // Espacio horizontal entre hermanos
          nodeSpacingY = CARD_HEIGHT + 100; // Espacio vertical entre niveles
          tree = d3.tree().nodeSize([nodeSpacingX, nodeSpacingY]);
        }
        
        tree(root);

        // Links
        const linksGroup = g.append("g")
          .attr("class", "links-layer")
          .attr("fill", "none")
          .attr("stroke", "#0071B9")
          .attr("stroke-opacity", 0.5)
          .attr("stroke-width", 2);
        
        if (currentOrientation === 'horizontal') {
          linksGroup.selectAll("path")
            .data(root.links())
            .join("path")
            .attr("d", d => {
              const sourceX = d.source.y + CARD_WIDTH;
              const sourceY = d.source.x;
              const targetX = d.target.y;
              const targetY = d.target.x;
              const midX = sourceX + (targetX - sourceX) / 2;
              
              return `M ${sourceX},${sourceY}
                      C ${midX},${sourceY}
                        ${midX},${targetY}
                        ${targetX},${targetY}`;
            });
        } else {
          linksGroup.selectAll("path")
            .data(root.links())
            .join("path")
            .attr("d", d => {
              const sourceX = d.source.x + CARD_WIDTH / 2;
              const sourceY = d.source.y + CARD_HEIGHT;
              const targetX = d.target.x + CARD_WIDTH / 2;
              const targetY = d.target.y;
              const midY = sourceY + (targetY - sourceY) / 2;
              
              return `M ${sourceX},${sourceY}
                      C ${sourceX},${midY}
                        ${targetX},${midY}
                        ${targetX},${targetY}`;
            });
        }

        // Nodos
        const nodesGroup = g.append("g").attr("class", "nodes-layer");
        
        const node = nodesGroup
          .selectAll("g")
          .data(root.descendants())
          .join("g")
          .attr("transform", d => {
            if (currentOrientation === 'horizontal') {
              return `translate(${d.y},${d.x - CARD_HEIGHT/2})`;
            } else {
              return `translate(${d.x},${d.y})`;
            }
          })
          .attr("class", "node-group");

        // Tarjeta
        node.append("rect")
          .attr("width", CARD_WIDTH)
          .attr("height", CARD_HEIGHT)
          .attr("rx", 6)
          .attr("fill", "#ffffff")
          .attr("stroke", "#e2e3e4")
          .attr("stroke-width", 1.5)
          .attr("class", "node-card")
          .on("click", (event, d) => showModal(d.data));

        // Barra superior
        node.append("rect")
          .attr("width", CARD_WIDTH)
          .attr("height", 4)
          .attr("rx", 6)
          .attr("fill", d => departmentColors[d.data.department] || '#0071B9');

        // Nombre
        node.append("text")
          .attr("y", 22)
          .attr("x", 10)
          .text(d => {
            const name = d.data.name;
            return name.length > 26 ? name.substring(0, 24) + '...' : name;
          })
          .attr("font-size", "11px")
          .attr("font-weight", "700")
          .attr("fill", "#000000");

        // Rol
        node.append("text")
          .attr("y", 38)
          .attr("x", 10)
          .text(d => {
            const role = d.data.role;
            return role.length > 30 ? role.substring(0, 28) + '...' : role;
          })
          .attr("font-size", "9px")
          .attr("font-weight", "500")
          .attr("fill", "#666666");

        // Segunda l√≠nea del rol si es muy largo
        node.filter(d => d.data.role.length > 30).append("text")
          .attr("y", 50)
          .attr("x", 10)
          .text(d => {
            const role = d.data.role;
            if (role.length > 30) {
              const rest = role.substring(28).trim();
              return rest.length > 28 ? rest.substring(0, 26) + '...' : rest;
            }
            return '';
          })
          .attr("font-size", "9px")
          .attr("font-weight", "500")
          .attr("fill", "#666666");

        // Departamento
        node.filter(d => d.data.department).append("text")
          .attr("y", CARD_HEIGHT - 8)
          .attr("x", 10)
          .text(d => {
            const dept = d.data.department.toUpperCase();
            return dept.length > 18 ? dept.substring(0, 16) + '...' : dept;
          })
          .attr("font-size", "8px")
          .attr("font-weight", "700")
          .attr("fill", d => departmentColors[d.data.department] || '#0071B9');

        // Indicador de reportes
        node.filter(d => d.children && d.children.length > 0).append("g")
          .attr("transform", `translate(${CARD_WIDTH - 20}, ${CARD_HEIGHT / 2})`)
          .call(g => {
            g.append("circle")
              .attr("r", 10)
              .attr("fill", "#0071B9")
              .attr("stroke", "#ffffff")
              .attr("stroke-width", 2);
            g.append("text")
              .attr("text-anchor", "middle")
              .attr("dy", "0.35em")
              .attr("font-size", "9px")
              .attr("font-weight", "700")
              .attr("fill", "#ffffff")
              .text(d => d.children.length);
          });
      }

      // ============================================
      // CAMBIO DE ORIENTACI√ìN
      // ============================================
      
      function toggleOrientation() {
        currentOrientation = currentOrientation === 'horizontal' ? 'vertical' : 'horizontal';
        
        const btn = document.getElementById('orientationBtn');
        btn.textContent = currentOrientation === 'horizontal' ? '‚ÜîÔ∏è' : '‚ÜïÔ∏è';
        btn.classList.toggle('active', currentOrientation === 'vertical');
        
        applyFilter();
      }

      // ============================================
      // B√öSQUEDA
      // ============================================
      
      document.getElementById('searchInput').addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase().trim();
        
        d3.selectAll('.node-card').classed('highlighted', false);
        
        if (searchTerm === '') return;
        
        d3.selectAll('.node-group').each(function(d) {
          const matches = 
            d.data.name.toLowerCase().includes(searchTerm) ||
            d.data.role.toLowerCase().includes(searchTerm) ||
            (d.data.department && d.data.department.toLowerCase().includes(searchTerm));
          
          if (matches) {
            d3.select(this).select('.node-card').classed('highlighted', true);
          }
        });
      });

      // ============================================
      // MODAL
      // ============================================
      
      function showModal(data) {
        document.getElementById('modalName').textContent = data.name;
        document.getElementById('modalRoleHeader').textContent = data.role;
        
        const deptElement = document.getElementById('modalDept');
        deptElement.textContent = data.department || 'N/A';
        deptElement.style.color = departmentColors[data.department] || '#0071B9';
        
        // Foto o iniciales
        const initials = data.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
        const initialsEl = document.getElementById('modalInitials');
        const photoImg = document.getElementById('modalPhotoImg');
        
        if (data.photo && data.photo.trim() !== '') {
          photoImg.src = data.photo;
          photoImg.classList.remove('hidden');
          initialsEl.classList.add('hidden');
          
          photoImg.onerror = function() {
            photoImg.classList.add('hidden');
            initialsEl.classList.remove('hidden');
            initialsEl.textContent = initials;
          };
        } else {
          photoImg.classList.add('hidden');
          initialsEl.classList.remove('hidden');
          initialsEl.textContent = initials;
        }
        
        // Descripci√≥n
        if (data.description && data.description.trim() !== '') {
          document.getElementById('modalDescSection').classList.remove('hidden');
          document.getElementById('modalDesc').textContent = data.description;
        } else {
          document.getElementById('modalDescSection').classList.add('hidden');
        }
        
        if (data.email) {
          document.getElementById('modalEmailSection').classList.remove('hidden');
          document.getElementById('modalEmail').textContent = data.email;
          document.getElementById('modalEmail').href = `mailto:${data.email}`;
        } else {
          document.getElementById('modalEmailSection').classList.add('hidden');
        }
        
        if (data.phone) {
          document.getElementById('modalPhoneSection').classList.remove('hidden');
          document.getElementById('modalPhone').textContent = data.phone;
        } else {
          document.getElementById('modalPhoneSection').classList.add('hidden');
        }
        
        const reports = data.children ? data.children.length : 0;
        document.getElementById('modalReports').textContent = reports === 0 ? 'None' : `${reports} people`;
        
        document.getElementById('modal').classList.remove('hidden');
      }

      function closeModal(event) {
        if (!event || event.target.id === 'modal') {
          document.getElementById('modal').classList.add('hidden');
        }
      }

      // ============================================
      // ZOOM
      // ============================================
      
      function resetZoom() {
        const scale = currentOrientation === 'horizontal' ? 0.7 : 0.5;
        svg.transition()
          .duration(750)
          .call(zoom.transform, d3.zoomIdentity.scale(scale));
      }

      function zoomIn() {
        svg.transition().duration(300).call(zoom.scaleBy, 1.3);
      }

      function zoomOut() {
        svg.transition().duration(300).call(zoom.scaleBy, 0.7);
      }

      // ============================================
      // EXPORTACI√ìN
      // ============================================
      
      function toggleDropdown(event) {
        event.stopPropagation();
        document.getElementById('exportDropdown').classList.toggle('show');
        document.getElementById('deptDropdownContent').classList.remove('show');
      }

      window.onclick = function(event) {
        if (!event.target.closest('.dropdown') && !event.target.closest('.dept-dropdown')) {
          document.getElementById('exportDropdown').classList.remove('show');
          document.getElementById('deptDropdownContent').classList.remove('show');
        }
      }
      
      function getBoundingBoxOfVisibleNodes() {
        const nodesLayer = g.select('.nodes-layer');
        const nodes = nodesLayer.selectAll('.node-group');
        
        let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
        
        nodes.each(function(d) {
          const transform = this.getAttribute('transform');
          let x = 0, y = 0;
          
          if (transform) {
            const match = transform.match(/translate\(([^,]+),([^)]+)\)/);
            if (match) {
              x = parseFloat(match[1]);
              y = parseFloat(match[2]);
            }
          }
          
          minX = Math.min(minX, x);
          minY = Math.min(minY, y);
          maxX = Math.max(maxX, x + CARD_WIDTH);
          maxY = Math.max(maxY, y + CARD_HEIGHT);
        });
        
        return { minX, minY, maxX, maxY };
      }
      
      async function exportToPNG() {
        document.getElementById('exportDropdown').classList.remove('show');
        document.getElementById('exportingOverlay').classList.remove('hidden');
        
        await new Promise(resolve => setTimeout(resolve, 100));
        
        try {
          const bbox = getBoundingBoxOfVisibleNodes();
          const margin = 50;
          
          const contentWidth = bbox.maxX - bbox.minX + margin * 2;
          const contentHeight = bbox.maxY - bbox.minY + margin * 2;
          
          const scale = 2;
          const finalWidth = Math.ceil(contentWidth * scale);
          const finalHeight = Math.ceil(contentHeight * scale);
          
          const tempSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
          tempSvg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
          tempSvg.setAttribute('width', finalWidth);
          tempSvg.setAttribute('height', finalHeight);
          tempSvg.setAttribute('viewBox', `${bbox.minX - margin} ${bbox.minY - margin} ${contentWidth} ${contentHeight}`);
          
          const bgRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
          bgRect.setAttribute('width', '100%');
          bgRect.setAttribute('height', '100%');
          bgRect.setAttribute('fill', '#ffffff');
          tempSvg.appendChild(bgRect);
          
          const styleEl = document.createElementNS('http://www.w3.org/2000/svg', 'style');
          styleEl.textContent = `text { font-family: 'Inter', 'Segoe UI', Arial, sans-serif; }`;
          tempSvg.appendChild(styleEl);
          
          const clonedG = g.node().cloneNode(true);
          clonedG.removeAttribute('transform');
          tempSvg.appendChild(clonedG);
          
          const serializer = new XMLSerializer();
          const svgString = serializer.serializeToString(tempSvg);
          const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
          const url = URL.createObjectURL(svgBlob);
          
          const img = new Image();
          img.onload = function() {
            const canvas = document.createElement('canvas');
            canvas.width = finalWidth;
            canvas.height = finalHeight;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
            
            const link = document.createElement('a');
            const timestamp = new Date().toISOString().split('T')[0];
            link.download = `Mondraker_Org_Chart_${timestamp}.png`;
            link.href = canvas.toDataURL('image/png', 1.0);
            link.click();
            
            URL.revokeObjectURL(url);
            document.getElementById('exportingOverlay').classList.add('hidden');
          };
          
          img.onerror = function() {
            const link = document.createElement('a');
            const timestamp = new Date().toISOString().split('T')[0];
            link.download = `Mondraker_Org_Chart_${timestamp}.svg`;
            link.href = url;
            link.click();
            document.getElementById('exportingOverlay').classList.add('hidden');
          };
          
          img.src = url;
          
        } catch (error) {
          console.error('Error:', error);
          alert('Error exporting. Please try again.');
          document.getElementById('exportingOverlay').classList.add('hidden');
        }
      }

      async function exportToPDF() {
        document.getElementById('exportDropdown').classList.remove('show');
        document.getElementById('exportingOverlay').classList.remove('hidden');
        
        await new Promise(resolve => setTimeout(resolve, 100));
        
        try {
          const bbox = getBoundingBoxOfVisibleNodes();
          const margin = 50;
          
          const contentWidth = bbox.maxX - bbox.minX + margin * 2;
          const contentHeight = bbox.maxY - bbox.minY + margin * 2;
          
          const aspectRatio = contentWidth / contentHeight;
          const orientation = aspectRatio > 1 ? 'landscape' : 'portrait';
          
          const { jsPDF } = window.jspdf;
          const pdf = new jsPDF({
            orientation: orientation,
            unit: 'mm',
            format: 'a3'
          });
          
          const pdfWidth = pdf.internal.pageSize.getWidth();
          const pdfHeight = pdf.internal.pageSize.getHeight();
          const pdfMargin = 10;
          
          const availableWidth = pdfWidth - pdfMargin * 2;
          const availableHeight = pdfHeight - pdfMargin * 2;
          const scaleX = availableWidth / (contentWidth * 0.264583);
          const scaleY = availableHeight / (contentHeight * 0.264583);
          const pdfScale = Math.min(scaleX, scaleY, 1);
          
          const imgWidth = contentWidth * 0.264583 * pdfScale;
          const imgHeight = contentHeight * 0.264583 * pdfScale;
          const xOffset = (pdfWidth - imgWidth) / 2;
          const yOffset = (pdfHeight - imgHeight) / 2;
          
          const renderScale = 2;
          const tempSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
          tempSvg.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
          tempSvg.setAttribute('width', contentWidth * renderScale);
          tempSvg.setAttribute('height', contentHeight * renderScale);
          tempSvg.setAttribute('viewBox', `${bbox.minX - margin} ${bbox.minY - margin} ${contentWidth} ${contentHeight}`);
          
          const bgRect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
          bgRect.setAttribute('width', '100%');
          bgRect.setAttribute('height', '100%');
          bgRect.setAttribute('fill', '#ffffff');
          tempSvg.appendChild(bgRect);
          
          const styleEl = document.createElementNS('http://www.w3.org/2000/svg', 'style');
          styleEl.textContent = `text { font-family: 'Inter', 'Segoe UI', Arial, sans-serif; }`;
          tempSvg.appendChild(styleEl);
          
          const clonedG = g.node().cloneNode(true);
          clonedG.removeAttribute('transform');
          tempSvg.appendChild(clonedG);
          
          const serializer = new XMLSerializer();
          const svgString = serializer.serializeToString(tempSvg);
          const svgBlob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
          const url = URL.createObjectURL(svgBlob);
          
          const img = new Image();
          img.onload = function() {
            const canvas = document.createElement('canvas');
            canvas.width = contentWidth * renderScale;
            canvas.height = contentHeight * renderScale;
            const ctx = canvas.getContext('2d');
            
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
            
            const imgData = canvas.toDataURL('image/png', 1.0);
            pdf.addImage(imgData, 'PNG', xOffset, yOffset, imgWidth, imgHeight);
            
            const timestamp = new Date().toISOString().split('T')[0];
            pdf.save(`Mondraker_Org_Chart_${timestamp}.pdf`);
            
            URL.revokeObjectURL(url);
            document.getElementById('exportingOverlay').classList.add('hidden');
          };
          
          img.onerror = function() {
            alert('Error generating PDF.');
            URL.revokeObjectURL(url);
            document.getElementById('exportingOverlay').classList.add('hidden');
          };
          
          img.src = url;
          
        } catch (error) {
          console.error('Error:', error);
          alert('Error exporting. Please try again.');
          document.getElementById('exportingOverlay').classList.add('hidden');
        }
      }

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeModal();
      });

      // ============================================
      // INICIALIZACI√ìN
      // ============================================
      
      function initializeApp() {
        if (typeof d3 === 'undefined') {
          document.getElementById('employeeCount').innerHTML = '<span class="text-red-500">‚ö†Ô∏è Error</span>';
          return;
        }
        loadData();
      }

      if (typeof d3 !== 'undefined' && typeof window.jspdf !== 'undefined') {
        initializeApp();
      }
    </script>
</body>
</html>
