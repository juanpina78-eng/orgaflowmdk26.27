<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organigrama Interactivo</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css">
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
      body { 
        font-family: 'Inter', sans-serif; 
        background-color: #f8fafc; 
        overflow: hidden;
        margin: 0;
        padding: 0;
      }
      .node-card { transition: all 0.3s ease-out; }
      .node-card:hover { transform: translateY(-3px); filter: drop-shadow(0 4px 3px rgb(0 0 0 / 0.07)); stroke: #93c5fd; }
      .node-name:hover { fill: #1d4ed8; }
      .node-indicator:hover { fill: #3b82f6; }
    </style>
</head>
<body>
    <div id="chart-container" style="width: 100vw; height: 100vh;"></div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script>
      // Verificar que D3 se cargó correctamente
      if (typeof d3 === 'undefined') {
        document.getElementById('chart-container').innerHTML = '<div style="padding: 20px; text-align: center; font-size: 18px;">Error: No se pudo cargar la librería D3. Por favor, recarga la página.</div>';
        throw new Error('D3 no se cargó correctamente');
      }

      // Datos del organigrama
      const data = {
        "name": "MIGUEL PINA",
        "role": "Chief Executive Officer (CEO)",
        "department": "Producto",
        "children": [
          {
            "name": "LUIS_MIGUEL MARTINEZ",
            "role": "Global Product Manager",
            "department": "Producto",
            "children": [
              {
                "name": "ANDRES CLIMENT",
                "role": "Design Engineer Lead",
                "department": "Producto",
                "children": [
                  {
                    "name": "MANUEL JURADO",
                    "role": "Ingeniero diseño industrial Jr",
                    "department": "Producto"
                  }
                ]
              },
              {
                "name": "SALVADOR MANCHÓN",
                "role": "Product Manager Senior",
                "department": "Producto",
                "children": [
                  {
                    "name": "FRANCISCO_JAVIER MARTINEZ",
                    "role": "Mecánica Process Manager A",
                    "department": "Producto"
                  },
                  {
                    "name": "ALEJANDRO SOLA",
                    "role": "Adjunto Product Manager",
                    "department": "Producto"
                  },
                  {
                    "name": "JAVIER ALFARO",
                    "role": "Adjunto Product Manager II",
                    "department": "Producto"
                  }
                ]
              },
              {
                "name": "JOSE_JUAN GINER",
                "role": "Quality Manager",
                "department": "Producto",
                "children": [
                  {
                    "name": "JOSE_LUIS NOGALES",
                    "role": "Quality Supervisor",
                    "department": "Producto"
                  }
                ]
              },
              {
                "name": "LEME, RICARDO",
                "role": "CTG Design Manager",
                "department": "Producto",
                "children": [
                  {
                    "name": "CESAR GONZALEZ",
                    "role": "CTG Junior Designer",
                    "department": "Producto"
                  }
                ]
              },
              {
                "name": "ISRAEL ROMERO",
                "role": "Product and comm. Manager",
                "department": "Producto"
              }
            ]
          },
          {
            "name": "JUAN PINA",
            "role": "Director de RRHH",
            "department": "RRHH",
            "children": [
              {
                "name": "ALBA PLANELLES",
                "role": "Laboral",
                "department": "RRHH"
              },
              {
                "name": "ANDRÉS GIL",
                "role": "Filiales",
                "department": "RRHH"
              }
            ]
          }
        ]
      };
      
      // Configuración del organigrama
      const CARD_WIDTH = 280;
      const CARD_HEIGHT = 100;
      const SPACING_V = 130;
      const SPACING_H = 350;

      const width = window.innerWidth;
      const height = window.innerHeight;

      const svg = d3.select("#chart-container").append("svg")
        .attr("viewBox", [-width / 2, -height / 2, width, height])
        .style("width", "100%")
        .style("height", "100%");

      const g = svg.append("g");
      
      const zoom = d3.zoom()
        .scaleExtent([0.1, 4])
        .on("zoom", (e) => g.attr("transform", e.transform));
      
      svg.call(zoom);
      svg.call(zoom.transform, d3.zoomIdentity.translate(width/4, height/2).scale(0.8));

      const root = d3.hierarchy(data);
      const tree = d3.tree().nodeSize([SPACING_V, SPACING_H]);
      tree(root);

      // Links
      g.append("g")
        .attr("fill", "none")
        .attr("stroke", "#cbd5e1")
        .attr("stroke-opacity", 0.6)
        .attr("stroke-width", 1.5)
        .selectAll("path")
        .data(root.links())
        .join("path")
        .attr("d", d3.linkHorizontal().x(d => d.y).y(d => d.x));

      // Nodes
      const node = g.append("g")
        .selectAll("g")
        .data(root.descendants())
        .join("g")
        .attr("transform", d => "translate(" + d.y + "," + d.x + ")")
        .attr("class", "group cursor-pointer");

      // Card
      node.append("rect")
        .attr("width", CARD_WIDTH)
        .attr("height", CARD_HEIGHT)
        .attr("x", 0)
        .attr("y", -CARD_HEIGHT / 2)
        .attr("rx", 12)
        .attr("fill", "white")
        .attr("stroke", "#e2e8f0")
        .attr("stroke-width", 1)
        .attr("class", "node-card shadow-sm");

      // Color Marker
      const colors = ["#2563eb", "#0ea5e9", "#8b5cf6", "#f59e0b", "#10b981", "#ec4899"];
      node.append("rect")
        .attr("width", 4)
        .attr("height", CARD_HEIGHT - 32)
        .attr("x", 12)
        .attr("y", -(CARD_HEIGHT / 2) + 16)
        .attr("rx", 2)
        .attr("fill", d => colors[d.depth % colors.length]);

      // Name
      node.append("text")
        .attr("dy", -18)
        .attr("x", 28)
        .text(d => d.data.name)
        .attr("class", "node-name")
        .attr("font-weight", "bold")
        .attr("fill", "#1e293b")
        .attr("font-size", "13px");

      // Role (Wrapped)
      node.each(function(d) {
          const el = d3.select(this);
          const roleText = el.append("text")
             .attr("x", 28)
             .attr("y", 2)
             .attr("fill", "#64748b")
             .attr("font-size", "11px")
             .attr("font-weight", "500");

          const words = d.data.role.split(/\s+/).reverse();
          let line = [];
          const lineHeight = 1.3;
          const maxWidth = CARD_WIDTH - 50;
          let tspan = roleText.append("tspan").attr("x", 28).attr("dy", 0);
          
          let word;
          while ((word = words.pop())) {
            line.push(word);
            tspan.text(line.join(" "));
            if (tspan.node().getComputedTextLength() > maxWidth) {
              line.pop();
              tspan.text(line.join(" "));
              line = [word];
              tspan = roleText.append("tspan").attr("x", 28).attr("dy", lineHeight + "em").text(word);
            }
          }
      });

      // Department
      node.filter(d => d.data.department).append("text")
        .attr("y", (CARD_HEIGHT / 2) - 16)
        .attr("x", 28)
        .text(d => d.data.department)
        .attr("fill", "#94a3b8")
        .attr("font-size", "10px")
        .attr("font-weight", "600");

      // Indicator
      node.filter(d => !!d.children || !!d.data.children).append("circle")
        .attr("cx", CARD_WIDTH)
        .attr("cy", 0)
        .attr("r", 4)
        .attr("fill", "#cbd5e1")
        .attr("stroke", "white")
        .attr("stroke-width", 2)
        .attr("class", "node-indicator transition-colors");

      console.log('Organigrama cargado correctamente');
    </script>
</body>
</html>
