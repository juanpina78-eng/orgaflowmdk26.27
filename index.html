<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organigrama Mondraker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
      
      body { 
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background: #000000;
        overflow: hidden; 
        margin: 0;
        padding: 0;
      }
      
      .node-card { 
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        cursor: pointer;
        filter: drop-shadow(0 4px 6px rgba(0, 0, 0, 0.3));
      }
      
      .node-card:hover { 
        transform: translateY(-4px) scale(1.02);
        filter: drop-shadow(0 12px 24px rgba(0, 113, 185, 0.4));
      }
      
      .node-card.highlighted { 
        stroke: #0071B9;
        stroke-width: 3;
        filter: drop-shadow(0 0 20px rgba(0, 113, 185, 0.8));
        animation: pulse 2s infinite;
      }
      
      @keyframes pulse {
        0%, 100% { filter: drop-shadow(0 0 20px rgba(0, 113, 185, 0.8)); }
        50% { filter: drop-shadow(0 0 30px rgba(0, 113, 185, 1)); }
      }
      
      .search-input {
        transition: all 0.3s;
        border: 2px solid #333;
        background: #1a1a1a;
        color: #ffffff;
      }
      
      .search-input:focus {
        border-color: #0071B9;
        box-shadow: 0 0 0 3px rgba(0, 113, 185, 0.1);
        outline: none;
      }
      
      .search-input::placeholder {
        color: #666;
      }
      
      #modal { 
        backdrop-filter: blur(10px);
        background: rgba(0, 0, 0, 0.85);
      }
      
      .fade-in { 
        animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      }
      
      @keyframes fadeIn { 
        from { opacity: 0; transform: translateY(-20px) scale(0.95); } 
        to { opacity: 1; transform: translateY(0) scale(1); } 
      }
      
      .btn-mondraker {
        background: #0071B9;
        transition: all 0.3s;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      
      .btn-mondraker:hover {
        background: #005a94;
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 113, 185, 0.4);
      }
      
      .btn-secondary {
        background: #333;
        transition: all 0.3s;
      }
      
      .btn-secondary:hover {
        background: #444;
      }
      
      .logo-mondraker {
        font-weight: 800;
        letter-spacing: -0.5px;
        color: #ffffff;
      }
    </style>
</head>
<body class="w-screen h-screen">
    <!-- Panel de Control Superior -->
    <div class="absolute top-0 left-0 right-0 z-50 bg-black border-b-2 border-gray-800 fade-in">
      <div class="max-w-7xl mx-auto px-6 py-4">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-4">
            <h1 class="logo-mondraker text-2xl">MONDRAKER</h1>
            <span class="text-gray-500 text-sm font-light">Organigrama Corporativo</span>
          </div>
          <div class="text-gray-400 text-sm">
            <span id="employeeCount">Cargando...</span>
          </div>
        </div>
        
        <div class="flex flex-wrap gap-3 items-center">
          <!-- B√∫squeda -->
          <div class="flex-1 min-w-72">
            <input 
              type="text" 
              id="searchInput" 
              placeholder="üîç Buscar empleado por nombre, puesto o departamento..." 
              class="search-input w-full px-4 py-3 rounded-lg text-sm font-medium"
            />
          </div>
          
          <!-- Filtros por Departamento -->
          <div class="flex gap-2 flex-wrap">
            <button onclick="filterDept('all')" class="dept-btn btn-mondraker px-5 py-3 text-white rounded-lg text-xs">
              TODOS
            </button>
            <button onclick="filterDept('Producto')" class="dept-btn btn-secondary px-5 py-3 text-white rounded-lg text-xs">
              PRODUCTO
            </button>
            <button onclick="filterDept('RRHH')" class="dept-btn btn-secondary px-5 py-3 text-white rounded-lg text-xs">
              RRHH
            </button>
          </div>
          
          <!-- Controles de Navegaci√≥n -->
          <div class="flex gap-2">
            <button onclick="resetZoom()" class="btn-secondary px-4 py-3 text-white rounded-lg text-xs font-bold">
              üè† INICIO
            </button>
            <button onclick="zoomIn()" class="btn-secondary px-4 py-3 text-white rounded-lg text-xs font-bold">
              ‚ûï
            </button>
            <button onclick="zoomOut()" class="btn-secondary px-4 py-3 text-white rounded-lg text-xs font-bold">
              ‚ûñ
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Contenedor del Organigrama -->
    <div id="chart-container" class="w-full h-full pt-36"></div>

    <!-- Modal de Detalles -->
    <div id="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4" onclick="closeModal(event)">
      <div class="bg-black border-2 border-gray-800 rounded-2xl shadow-2xl max-w-lg w-full p-8 fade-in" onclick="event.stopPropagation()">
        <div class="flex justify-between items-start mb-6">
          <div>
            <h2 id="modalName" class="text-3xl font-bold text-white mb-1"></h2>
            <div class="h-1 w-16 bg-gradient-to-r from-blue-500 to-transparent"></div>
          </div>
          <button onclick="closeModal()" class="text-gray-400 hover:text-white text-3xl transition">&times;</button>
        </div>
        
        <div class="space-y-4">
          <div class="bg-gray-900 rounded-lg p-4 border border-gray-800">
            <p class="text-xs text-gray-500 uppercase tracking-wider mb-1 font-semibold">Puesto</p>
            <p id="modalRole" class="text-lg font-bold text-white"></p>
          </div>
          
          <div class="bg-gray-900 rounded-lg p-4 border border-gray-800">
            <p class="text-xs text-gray-500 uppercase tracking-wider mb-1 font-semibold">Departamento</p>
            <p id="modalDept" class="text-lg font-bold text-blue-400"></p>
          </div>
          
          <div id="modalEmailSection" class="bg-gray-900 rounded-lg p-4 border border-gray-800 hidden">
            <p class="text-xs text-gray-500 uppercase tracking-wider mb-1 font-semibold">Email</p>
            <a id="modalEmail" href="#" class="text-base font-semibold text-blue-400 hover:text-blue-300 transition"></a>
          </div>
          
          <div id="modalPhoneSection" class="bg-gray-900 rounded-lg p-4 border border-gray-800 hidden">
            <p class="text-xs text-gray-500 uppercase tracking-wider mb-1 font-semibold">Tel√©fono</p>
            <p id="modalPhone" class="text-base font-semibold text-white"></p>
          </div>
          
          <div class="bg-gray-900 rounded-lg p-4 border border-gray-800">
            <p class="text-xs text-gray-500 uppercase tracking-wider mb-1 font-semibold">Reportes Directos</p>
            <p id="modalReports" class="text-lg font-bold text-white"></p>
          </div>
        </div>
      </div>
    </div>

    <script>
      // ============================================
      // CONFIGURACI√ìN
      // ============================================
      // OPCI√ìN 1: Usa Google Apps Script (RECOMENDADO - sin problemas CORS)
      const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzlozZEso7yKBhymlR3Glg4K_zs2k6-v4j0ti8XIbLFELXD1QR0RnD12_h_wIb51Lib/exec';
      
      // OPCI√ìN 2: Usa datos embebidos para prueba
      const USE_EMBEDDED_DATA = false;
      
      // Datos de ejemplo
      const embeddedData = [
        {name: "MIGUEL PINA", role: "Chief Executive Officer (CEO)", department: "Producto", manager: "", email: "miguel.pina@mondraker.com", phone: "+34 600 000 000"},
        {name: "LUIS_MIGUEL MARTINEZ", role: "Global Product Manager", department: "Producto", manager: "MIGUEL PINA", email: "luis.martinez@mondraker.com", phone: ""},
        {name: "ANDRES CLIMENT", role: "Design Engineer Lead", department: "Producto", manager: "LUIS_MIGUEL MARTINEZ", email: "", phone: ""},
        {name: "MANUEL JURADO", role: "Ingeniero dise√±o industrial Jr", department: "Producto", manager: "ANDRES CLIMENT", email: "", phone: ""},
        {name: "SALVADOR MANCH√ìN", role: "Product Manager Senior", department: "Producto", manager: "LUIS_MIGUEL MARTINEZ", email: "", phone: ""},
        {name: "FRANCISCO_JAVIER MARTINEZ", role: "Mec√°nica Process Manager A", department: "Producto", manager: "SALVADOR MANCH√ìN", email: "", phone: ""},
        {name: "ALEJANDRO SOLA", role: "Adjunto Product Manager", department: "Producto", manager: "SALVADOR MANCH√ìN", email: "", phone: ""},
        {name: "JAVIER ALFARO", role: "Adjunto Product Manager II", department: "Producto", manager: "SALVADOR MANCH√ìN", email: "", phone: ""},
        {name: "JOSE_JUAN GINER", role: "Quality Manager", department: "Producto", manager: "LUIS_MIGUEL MARTINEZ", email: "", phone: ""},
        {name: "JOSE_LUIS NOGALES", role: "Quality Supervisor", department: "Producto", manager: "JOSE_JUAN GINER", email: "", phone: ""},
        {name: "LEME, RICARDO", role: "CTG Design Manager", department: "Producto", manager: "LUIS_MIGUEL MARTINEZ", email: "", phone: ""},
        {name: "CESAR GONZALEZ", role: "CTG Junior Designer", department: "Producto", manager: "LEME, RICARDO", email: "", phone: ""},
        {name: "ISRAEL ROMERO", role: "Product and comm. Manager", department: "Producto", manager: "LUIS_MIGUEL MARTINEZ", email: "", phone: ""},
        {name: "JUAN PINA", role: "Director de RRHH", department: "RRHH", manager: "MIGUEL PINA", email: "juan.pina@mondraker.com", phone: "+34 600 111 111"},
        {name: "ALBA PLANELLES", role: "Laboral", department: "RRHH", manager: "JUAN PINA", email: "", phone: ""},
        {name: "ANDR√âS GIL", role: "Filiales", department: "RRHH", manager: "JUAN PINA", email: "", phone: ""}
      ];

      // Variables globales
      let allData = [];
      let currentFilter = 'all';
      let svg, g, zoom, root, tree;
      
      const CARD_WIDTH = 260;
      const CARD_HEIGHT = 90;
      const SPACING_V = 120;
      const SPACING_H = 340;
      const width = window.innerWidth;
      const height = window.innerHeight;

      // Funci√≥n para convertir datos planos a jerarqu√≠a
      function buildHierarchy(flatData) {
        const map = {};
        const roots = [];
        
        flatData.forEach(person => {
          map[person.name] = {
            name: person.name,
            role: person.role,
            department: person.department,
            email: person.email || '',
            phone: person.phone || '',
            children: []
          };
        });
        
        flatData.forEach(person => {
          if (person.manager && map[person.manager]) {
            map[person.manager].children.push(map[person.name]);
          } else {
            roots.push(map[person.name]);
          }
        });
        
        return roots.length === 1 ? roots[0] : { name: "Organizaci√≥n", role: "", department: "", children: roots };
      }

      // Cargar datos
      async function loadData() {
        try {
          if (USE_EMBEDDED_DATA) {
            allData = embeddedData;
            initializeChart();
          } else {
            const response = await fetch(APPS_SCRIPT_URL);
            const data = await response.json();
            allData = data;
            initializeChart();
          }
        } catch (error) {
          console.error('Error cargando datos:', error);
          document.getElementById('employeeCount').innerHTML = 
            '<span class="text-red-500">‚ö†Ô∏è Error al cargar datos</span>';
        }
      }

      // Inicializar el organigrama
      function initializeChart() {
        document.getElementById('employeeCount').innerHTML = 
          `<span class="text-white font-bold">${allData.length}</span> <span class="text-gray-500">empleados</span>`;
        
        svg = d3.select("#chart-container").append("svg")
          .attr("viewBox", [-width / 2, -height / 2, width, height])
          .style("width", "100%")
          .style("height", "100%");

        g = svg.append("g");
        
        zoom = d3.zoom()
          .scaleExtent([0.1, 4])
          .on("zoom", (e) => g.attr("transform", e.transform));
        
        svg.call(zoom);
        
        renderChart(allData);
        resetZoom();
      }

      // Renderizar organigrama
      function renderChart(data) {
        g.selectAll("*").remove();
        
        const hierarchyData = buildHierarchy(data);
        root = d3.hierarchy(hierarchyData);
        tree = d3.tree().nodeSize([SPACING_V, SPACING_H]);
        tree(root);

        // Links (conexiones)
        g.append("g")
          .attr("fill", "none")
          .attr("stroke", "#0071B9")
          .attr("stroke-opacity", 0.3)
          .attr("stroke-width", 2)
          .selectAll("path")
          .data(root.links())
          .join("path")
          .attr("d", d3.linkHorizontal().x(d => d.y).y(d => d.x));

        // Nodos
        const node = g.append("g")
          .selectAll("g")
          .data(root.descendants())
          .join("g")
          .attr("transform", d => `translate(${d.y},${d.x})`)
          .attr("class", "node-group");

        // Tarjeta principal
        node.append("rect")
          .attr("width", CARD_WIDTH)
          .attr("height", CARD_HEIGHT)
          .attr("x", 0)
          .attr("y", -CARD_HEIGHT / 2)
          .attr("rx", 8)
          .attr("fill", "#1a1a1a")
          .attr("stroke", "#333")
          .attr("stroke-width", 1)
          .attr("class", "node-card")
          .on("click", (event, d) => showModal(d.data));

        // Barra superior azul Mondraker
        node.append("rect")
          .attr("width", CARD_WIDTH)
          .attr("height", 6)
          .attr("x", 0)
          .attr("y", -CARD_HEIGHT / 2)
          .attr("rx", 8)
          .attr("fill", "#0071B9");

        // Nombre
        node.append("text")
          .attr("dy", -12)
          .attr("x", 16)
          .text(d => d.data.name)
          .attr("class", "font-bold text-sm")
          .attr("fill", "#ffffff");

        // Puesto (con wrap)
        node.each(function(d) {
          const el = d3.select(this);
          const roleText = el.append("text")
            .attr("x", 16)
            .attr("y", 8)
            .attr("class", "text-[11px] font-medium uppercase tracking-wide")
            .attr("fill", "#888");

          const words = d.data.role.split(/\s+/).reverse();
          let line = [];
          const lineHeight = 1.3;
          const maxWidth = CARD_WIDTH - 32;
          let tspan = roleText.append("tspan").attr("x", 16).attr("dy", "0em");
          
          let word;
          while ((word = words.pop())) {
            line.push(word);
            tspan.text(line.join(" "));
            if (tspan.node().getComputedTextLength() > maxWidth) {
              line.pop();
              tspan.text(line.join(" "));
              line = [word];
              tspan = roleText.append("tspan").attr("x", 16).attr("dy", lineHeight + "em").text(word);
            }
          }
        });

        // Departamento
        node.filter(d => d.data.department).append("text")
          .attr("y", (CARD_HEIGHT / 2) - 14)
          .attr("x", 16)
          .text(d => d.data.department.toUpperCase())
          .attr("class", "text-[10px] font-bold tracking-wider")
          .attr("fill", "#0071B9");

        // Indicador de reportes directos
        node.filter(d => d.children && d.children.length > 0).append("g")
          .attr("transform", `translate(${CARD_WIDTH - 30}, 0)`)
          .call(g => {
            g.append("circle")
              .attr("r", 14)
              .attr("fill", "#0071B9")
              .attr("stroke", "#000")
              .attr("stroke-width", 2);
            g.append("text")
              .attr("text-anchor", "middle")
              .attr("dy", "0.35em")
              .attr("class", "text-xs font-bold")
              .attr("fill", "#ffffff")
              .text(d => d.children.length);
          });
      }

      // B√∫squeda
      document.getElementById('searchInput').addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase().trim();
        
        d3.selectAll('.node-card').classed('highlighted', false);
        
        if (searchTerm === '') return;
        
        d3.selectAll('.node-group').each(function(d) {
          const matches = 
            d.data.name.toLowerCase().includes(searchTerm) ||
            d.data.role.toLowerCase().includes(searchTerm) ||
            (d.data.department && d.data.department.toLowerCase().includes(searchTerm));
          
          if (matches) {
            d3.select(this).select('.node-card').classed('highlighted', true);
          }
        });
      });

      // Filtro por departamento
      function filterDept(dept) {
        currentFilter = dept;
        
        document.querySelectorAll('.dept-btn').forEach(btn => {
          btn.classList.remove('btn-mondraker');
          btn.classList.add('btn-secondary');
        });
        event.target.classList.remove('btn-secondary');
        event.target.classList.add('btn-mondraker');
        
        const filtered = dept === 'all' 
          ? allData 
          : allData.filter(p => p.department === dept);
        
        document.getElementById('employeeCount').innerHTML = 
          `<span class="text-white font-bold">${filtered.length}</span> <span class="text-gray-500">de ${allData.length} empleados</span>`;
        
        renderChart(filtered);
      }

      // Modal de detalles
      function showModal(data) {
        document.getElementById('modalName').textContent = data.name;
        document.getElementById('modalRole').textContent = data.role;
        document.getElementById('modalDept').textContent = data.department || 'N/A';
        
        if (data.email) {
          document.getElementById('modalEmailSection').classList.remove('hidden');
          document.getElementById('modalEmail').textContent = data.email;
          document.getElementById('modalEmail').href = `mailto:${data.email}`;
        } else {
          document.getElementById('modalEmailSection').classList.add('hidden');
        }
        
        if (data.phone) {
          document.getElementById('modalPhoneSection').classList.remove('hidden');
          document.getElementById('modalPhone').textContent = data.phone;
        } else {
          document.getElementById('modalPhoneSection').classList.add('hidden');
        }
        
        const reports = data.children ? data.children.length : 0;
        document.getElementById('modalReports').textContent = reports === 0 ? 'Ninguno' : reports;
        
        document.getElementById('modal').classList.remove('hidden');
      }

      function closeModal(event) {
        if (!event || event.target.id === 'modal') {
          document.getElementById('modal').classList.add('hidden');
        }
      }

      // Controles de zoom
      function resetZoom() {
        svg.transition().duration(750).call(
          zoom.transform,
          d3.zoomIdentity.translate(width/4, height/2).scale(0.7)
        );
      }

      function zoomIn() {
        svg.transition().duration(300).call(zoom.scaleBy, 1.3);
      }

      function zoomOut() {
        svg.transition().duration(300).call(zoom.scaleBy, 0.7);
      }

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeModal();
      });

      // Iniciar
      loadData();
    </script>
</body>
</html>
